<?php

declare(strict_types=1);

use App\Commands\AnalizeCommand;
use App\Commands\CacheForgetCommand;
use App\Commands\CacheGetCommand;
use App\Commands\CachePutCommand;
use App\Commands\HelpCommand;
use App\Commands\ServicesCacheWarmCommand;
use App\Commands\ServicesCommand;
use App\Commands\VisitCommand;
use App\Commands\VisitorDetailsCommand;
use App\Commands\VisitorDetailsExportCommand;
use App\PCare;
use GuzzleHttp\Client;
use System\Cache\Storage\FileStorage;

require_once __DIR__ . '/vendor/autoload.php';

$cache = new FileStorage(__DIR__ . '/cache', 7_884_008); // 3 month
$pcare = new PCare(new Client([
    'base_uri'    => 'http://127.0.0.1:3000',
    'http_errors' => false,
]));

$copy_argv = $argv ?? ['cli', 'help'];
array_shift($copy_argv);
$option = array_shift($copy_argv);

$services = match ($option) {
    // main command
    'service:visit'   => VisitCommand::class,
    'service:detail'  => ServicesCommand::class,
    'service:analize' => AnalizeCommand::class,
    // analize commnad
    'visit:detail'    => VisitorDetailsCommand::class,
    'visit:export'    => VisitorDetailsExportCommand::class,
    // other
    'cache:forget'       => CacheForgetCommand::class,
    'cache:get'          => CacheGetCommand::class,
    'cache:put'          => CachePutCommand::class,
    'cache:service:warm' => ServicesCacheWarmCommand::class,
    default              => HelpCommand::class,
};

/** @var App\Commands\Command */
$app = new $services($argv, __DIR__, $cache, $pcare);

$exit = $app->__main();

exit($exit);
